
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>TESTimony - Dream Agile</title>
  <meta name="author" content="Dan Carper">

  
  <meta name="description" content="Preface This is a high level musing on TDD/BDD. I&#8217;m far from a guru so everything should be considered up for debate. I try to stay as general &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://DCarper.github.com/DCarper/blog/2011/12/23/testimony">
  <link href="/dcarper/favicon.png" rel="icon">
  <link href="/dcarper/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/dcarper/javascripts/modernizr-2.0.js"></script>
  <script src="/dcarper/javascripts/ender.js"></script>
  <script src="/dcarper/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/dcarper/atom.xml" rel="alternate" title="Dream Agile" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/dcarper/">Dream Agile</a></h1>
  
    <h2>Progress through community.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/dcarper/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:DCarper.github.com/DCarper" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/dcarper/">Blog</a></li>
  <li><a href="/dcarper/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">TESTimony</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-23T11:15:00-05:00" pubdate data-updated="true">Dec 23<span>rd</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><h3>Preface</h3>

<p>This is a high level musing on TDD/BDD. I&#8217;m far from a guru so everything should be considered up for debate.</p>

<p>I try to stay as general as possible but a lot of what I say is in the context of a Rails app.</p>

<h3>Why write automated tests?</h3>

<p>Because you&#8217;re going to test anyway. You&#8217;re <em>are</em> going to run some code after every tiny little change right? You&#8217;re either going to refresh the gui or reload your console. Chances are you need a specific setup to test the bit of code you&#8217;re working with as well. I can remember before I started writing test scripts that I would up-tab through a good 4-5 lines in addition to a possible browser refresh / clicks / form interaction. If you think you can do this by hand faster than a script you are out of your mind.</p>

<p>It also allows you to test code in isolation. Through test doubles such as mocks, stubs, and spies it becomes very easy to eliminate dependencies of a given piece of code. These doubles also allow you to manipulate things like time which are not-so-cool to work with otherwise.</p>

<p>Good tests also lead to cleaner code. Truth.</p>

<p>You&#8217;re also able to easily pop open a debugger console within any part of the stack. From here, you can see what variables are defined and what methods they have access to. This helps soften the blow of not having an IntelliType functionality.</p>

<p>Last but certainly not least, there is the regression factor. When I add a new feature to an existing codebase, I break things more often then not. It&#8217;s completely impractical to believe I could go in and test every function point by hand of the application for a tiny little tweak. With a trust-worthy test-suite, it is very nice to be able to say, &#8220;Well all tests are passing so I&#8217;m gonna deploy&#8221;.</p>

<h3>Why write tests first?</h3>

<p>Because you&#8217;ll never write them otherwise. Because you <em>only</em> gain the regression benefit if you <em>don&#8217;t</em> write them first. Because if you do indeed have working code first, you&#8217;ve broken red-green-refactor.</p>

<h3>Why red-green-refactor?</h3>

<p>A tree that falls in the woods <em>doesn&#8217;t</em> make a noise unless some being is around to observe. A solid 90% of the time you will eliminate 100% of you&#8217;re false positives by writing a test, watching it fail, then writing the code to make it pass.</p>

<p>Fail-pass-refactor also faciliates getting the job done quickly (write just enough code to meet the requirements). It also facilitates getting the job done correctly. After you&#8217;ve thrown mud on the wall till requirements are met, evaluate your code and clean things up, all under the safety net of tests that <em>were</em> passing at one point.</p>

<h3>Why NOT one-assertion-per-test</h3>

<p>This is a controversial topic. Google it if you&#8217;re not familiar.</p>

<p>In general I&#8217;m against blanket rules like this. As an apprentice craftsman, artist, and Rubyist I will do what I think is most beautiful at any given time. I&#8217;m all for one ACTION per test. You have your setup, you take an action, and you look for the results.</p>

<p>The arguments FOR one assertion-per-test seem great in theory but fall apart in the trenches. This topic really deserves a separate blog post so I won&#8217;t get too into things here.</p>

<h3>What kind of tests are there?</h3>

<p>Bunches. Unit, integration, functional, acceptance, etc. As far as I&#8217;m concerned, there are two kinds of tests. If you&#8217;re simulating a user-action then it&#8217;s an acceptance test. If you&#8217;re testing a specific small bit of code then it&#8217;s a unit test.</p>

<h3>Acceptance Tests</h3>

<p><em>Fill this form out</em> then <em>look for the confirmation</em></p>

<p><em>Click this link</em> then <em>I should be on the homepage</em></p>

<p>Acceptance tests simulate the user. There&#8217;s usually longer strings of steps involved with navigatin and interaction. I like using the Gherkin gem to group blocks of code to plaintext signatures like, &#8220;When I register as a new user&#8221; to really capture what is going on at a high level.</p>

<figure class='code'><figcaption><span>Feature</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Feature</span><span class="p">:</span> <span class="no">Product</span> <span class="no">Registration</span>
</span><span class='line'>  <span class="no">In</span> <span class="n">order</span> <span class="n">register</span> <span class="n">a</span> <span class="n">product</span>
</span><span class='line'>  <span class="no">As</span> <span class="n">anyone</span><span class="o">.</span><span class="n">.</span>
</span><span class='line'>  <span class="n">I</span> <span class="n">should</span> <span class="n">be</span> <span class="n">able</span> <span class="n">submit</span> <span class="n">a</span> <span class="n">form</span> <span class="n">to</span> <span class="n">register</span> <span class="n">a</span> <span class="n">product</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Scenario</span><span class="p">:</span> <span class="n">I</span> <span class="n">should</span> <span class="n">be</span> <span class="n">able</span> <span class="n">to</span> <span class="n">register</span> <span class="n">an</span> <span class="no">Widget</span>
</span><span class='line'>      <span class="no">When</span> <span class="n">I</span> <span class="n">fill</span> <span class="k">in</span> <span class="n">my</span> <span class="n">info</span>
</span><span class='line'>      <span class="no">And</span> <span class="n">I</span> <span class="n">register</span> <span class="n">a</span> <span class="no">Widget</span>
</span><span class='line'>      <span class="no">Then</span> <span class="n">I</span> <span class="n">should</span> <span class="n">see</span> <span class="n">a</span> <span class="n">confirmation</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Step Definitions</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">When</span><span class="sr"> /^I fill in my info$/</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;product_registration_first_name&#39;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s1">&#39;Andy&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;product_registration_last_name&#39;</span><span class="p">,</span>  <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s1">&#39;Smith&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;product_registration_address1&#39;</span><span class="p">,</span>   <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s1">&#39;40 24th St&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;product_registration_city&#39;</span><span class="p">,</span>       <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s1">&#39;Pittsburgh&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;product_registration_zip&#39;</span><span class="p">,</span>        <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s1">&#39;15222&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;product_registration_email&#39;</span><span class="p">,</span>        <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s1">&#39;who@who.com&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">select</span><span class="p">(</span><span class="s1">&#39;PA&#39;</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;product_registration_state&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">When</span><span class="sr"> /^I register a Widget$/</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">select_product</span><span class="p">(</span><span class="s1">&#39;Widget&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Then</span><span class="sr"> /^I should see a confirmation$/</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;Thanks for registering your Widget!!!&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">select_product</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">select</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;product_registration_product_id&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I think the above is much more meaningful than cramming all of the actual code into one long script.</p>

<p>As far as web apps go, I think navigation and form interaction are the only things worthy of an acceptance test. Even dynamic view rendering <em>only</em> happens on the server. I could see a case being made for having acceptance tests for in-page behavior (IE display this modal). However acceptance tests are usually much slower than unit tests, and javascript can be tested very well with tools like Jasmine.</p>

<p>Another flag to look for as far as client-server based apps. If you&#8217;re test is not bouncing back and forth between the client and server at least once after the initial request is made, then it doesn&#8217;t get an acceptance test. Acceptance tests drill down through the whole stack and then right back up.</p>

<h3>Unit Tests</h3>

<p>Why are unit tests necessary? Because an acceptance tests covers a ton of code at all levels of the stack and probably involve a more expensive setup than what you need to test if a user can access a given article.</p>

<p>Unit tests are much faster because of this. A unit test might look something like&#8230;</p>

<figure class='code'><figcaption><span>user_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;validations&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should validate presence of first name&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">should</span> <span class="n">validate_presence_of</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;#can_enter_contest?&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should return true if the user has no entries&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@user</span><span class="o">.</span><span class="n">can_enter_contest?</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should return false if the user create&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="no">Factory</span><span class="p">(</span><span class="ss">:entry</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">can_enter_contest?</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should return true if last entry was created yesterday&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="no">Factory</span><span class="p">(</span><span class="ss">:entry</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>
</span><span class='line'>      <span class="no">Timecop</span><span class="o">.</span><span class="n">travel</span><span class="p">(</span><span class="no">Chronic</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;midnight&#39;</span><span class="p">))</span>
</span><span class='line'>      <span class="vi">@user</span><span class="o">.</span><span class="n">can_enter_contest?</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&#8217;m pretty framework agnostic. I have the most experience with Rspec. A good framework should provide cascading setups and teardowns. A good framework should also facilitate <em>matchers</em> or domain-specific test methods such as <em>#validate_presence_of</em></p>

<p>So what exactly gets unit-tested?</p>

<p><strong>View:</strong> javascript, aesthetics, and dynamic rendering.</p>

<p><strong>Controller:</strong> template rendering and redirects.</p>

<p><strong>Model:</strong> Scopes, queries, callbacks, validations, and any other methods.</p>

<p><strong>Routes:</strong> Routes can easily be unit-tested but I feel like they&#8217;re always covered somewhere else so I tend to not unit-test these.</p>

<h3>Quandry</h3>

<p>To date, I&#8217;ve tested dynamic rendering with acceptance tests. I see the fail first in the view template, then I add in the code <em>&lt;%= @user.first_name %></em> which fails because @user doesn&#8217;t exist, so then I initialize it in the controller and I&#8217;m green. However, there&#8217;s no client-server-client action here. It&#8217;s just a request. As such I don&#8217;t think it&#8217;s worthy of the overhead associated with acceptance tests.</p>

<p>The coupling between a view-template and its corresponding controller-action seems much more like an integration test to me. At least within Rspec controller tests, you can <em>#render_views</em> and look for content in the response. This seems much more useful than #assigning specific instance variables and rendering a template by filename, and much more lightweight than firing up an acceptance test. I have yet to try this however and am totally open to debate.</p>

<h3>Other helpful testing tools</h3>

<p>Factories. Never create data by hand, and don&#8217;t use fixtures. Fixtures are the opposite of maintainable and extendable. Factories allow you to automate and DRY up all of your data needs. I like factory_girl.</p>

<p>Database management. Find a tool that cleanses the data automatically after each test or you will get very hard-to-debug fails.</p>

<p>Mocks and stubs. Many frameworks provide these out of the box. I prefer mocha which lets you say things like, <em>User.any_instance.stubs(:first_name).etc</em></p>

<p>Time management. If you have time sensitive code and you&#8217;re using a well-supported language, there&#8217;s probably a wrapper library which lets you eloquently jump back and forth through time.</p>

<h3>Putting it all together</h3>

<p>So how does this all work together in the trenches? Lets assume we have a brand new rails app and we need to build a user-registration form.</p>

<ol>
<li>Write an acceptance test&#8230; Fill out the user form, look for a placeholder to signify being logged in.

<ul>
<li>Fails because there is no form</li>
</ul>
</li>
<li>Write the form

<ul>
<li>Fails because you&#8217;ve referenced @user that hasn&#8217;t been defined.</li>
</ul>
</li>
<li>Unit-test a controller, make sure the action renders the correct template

<ul>
<li>Fails because there is no controller</li>
</ul>
</li>
<li>Write the controller

<ul>
<li>Initially passes because you&#8217;re not defining user yet</li>
<li>Your acceptance test still fails because @user is still not defined</li>
<li>Define @user</li>
<li>controller test fails now because there is no User class</li>
</ul>
</li>
<li>Unit-test the User model

<ul>
<li>fails because there is no User model</li>
</ul>
</li>
<li>Create the User model</li>
<li>User unit-tests pass</li>
<li>User&#8217;s Controller tests pass</li>
<li>You&#8217;re original acceptance test passes</li>
<li>Success!</li>
</ol>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Dan Carper</span></span>

      








  


<time datetime="2011-12-23T11:15:00-05:00" pubdate data-updated="true">Dec 23<span>rd</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/dcarper/blog/categories/bdd/'>BDD</a>, <a class='category' href='/dcarper/blog/categories/rails/'>Rails</a>, <a class='category' href='/dcarper/blog/categories/tdd/'>TDD</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://DCarper.github.com/DCarper/blog/2011/12/23/testimony/" data-via="" data-counturl="http://DCarper.github.com/DCarper/blog/2011/12/23/testimony/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/dcarper/blog/2011/12/23/testimony/">TESTimony</a>
      </li>
    
  </ul>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Dan Carper -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
